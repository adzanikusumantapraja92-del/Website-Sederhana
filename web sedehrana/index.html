<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Portal ‚Äî Launcher (Offline)</title>
<style>
/* =========================
   THEME & LAYOUT (clean pro)
   ========================= */
:root{
  --bg: #f6f9ff;
  --card: #ffffff;
  --muted: #64748b;
  --primary: #1e40af;
  --accent: #60a5fa;
  --danger: #ef4444;
  --radius: 12px;
  --shadow: 0 14px 40px rgba(30,64,175,0.06);
}
*{box-sizing:border-box;font-family:Inter, "Segoe UI", Roboto, Arial; transition: all .12s ease;}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#f8fbff,#eef6ff);color:#071133}
.header{
  max-width:1200px;margin:18px auto;display:flex;align-items:center;justify-content:space-between;padding:8px 18px;
}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
.title{font-size:18px;margin:0}
.subtitle{font-size:13px;color:var(--muted)}
.controls{display:flex;gap:10px;align-items:center}

/* main layout: content + right column (notes) */
.container{max-width:1200px;margin:10px auto;padding:0 18px;display:grid;grid-template-columns:1fr 340px;gap:18px}
@media (max-width:980px){ .container{grid-template-columns:1fr} }

/* panel */
.panel{background:var(--card);border-radius:14px;padding:16px;box-shadow:var(--shadow);border:1px solid rgba(14,165,233,0.06)}

/* search */
.searchRow{display:flex;gap:8px;margin-bottom:12px}
.searchRow input{flex:1;padding:12px;border-radius:12px;border:1px solid #e6eefb;font-size:15px}
.btn{padding:8px 12px;border-radius:10px;border:0;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(14,165,233,0.08);color:var(--primary);font-weight:600}
.btn.small{padding:6px 8px;border-radius:8px}

/* categories grid */
.categories{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
.catCard{padding:14px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid rgba(15,23,42,0.03);display:flex;flex-direction:column;gap:10px;align-items:center;min-height:160px; user-select:none}
.catBig{width:88px;height:88px;border-radius:999px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:26px;overflow:hidden;cursor:grab}
.catName{font-weight:700;text-align:center}
.linkIcons{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:6px}
.linkSmall{width:40px;height:40px;border-radius:999px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;border:1px solid rgba(15,23,42,0.03)}

/* right notes */
.notesHeader{display:flex;justify-content:space-between;align-items:center}
.notesList{margin-top:12px;display:flex;flex-direction:column;gap:10px;max-height:72vh;overflow:auto}
.noteCard{padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid rgba(15,23,42,0.03)}

/* modal */
.backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:80;padding:18px}
.modal{width:100%;max-width:880px;background:var(--card);border-radius:12px;padding:16px;border:1px solid rgba(2,6,23,0.06);box-shadow:0 30px 80px rgba(2,6,23,0.22)}
.modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.formRow{display:flex;gap:8px;margin-bottom:8px}
.formRow input,.formRow select,textarea{padding:10px;border-radius:8px;border:1px solid #e6eefb;width:100%}

/* small helpers */
.muted{color:var(--muted);font-size:13px}
.small{font-size:13px}
.kv{font-weight:700;color:#0b1220}

/* drag placeholder effect */
.dragging{opacity:0.5; transform:scale(.98)}

/* tooltip-like title on small icons */
.linkSmall[title]{position:relative}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="brand">
    <div class="logo">AL</div>
    <div>
      <div class="title">Portal ‚Äî Launcher</div>
      <div class="subtitle">Simpan link & catatan ‚Äî offline. Klik kategori untuk lihat link.</div>
    </div>
  </div>

  <div class="controls">
    <button class="btn.ghost" onclick="openImportModal()">üì• Import/Export</button>
    <button class="btn.ghost" onclick="openManageModal()">‚öôÔ∏è Kelola</button>
    <button class="btn" onclick="openAddCategory()">+ Kategori</button>
  </div>
</div>

<!-- MAIN LAYOUT -->
<div class="container">
  <!-- LEFT: categories -->
  <main>
    <div class="panel">
      <div class="searchRow">
        <input id="searchMain" placeholder="Cari kategori atau link..." oninput="renderCategories()">
        <button class="btn small" onclick="document.getElementById('searchMain').focus()">Cari</button>
      </div>

      <div class="muted center small" style="text-align:center;margin-bottom:10px">Ikon kategori ‚Äî klik untuk lihat daftar link</div>
      <div id="categoriesArea" class="categories" ondragover="event.preventDefault()"></div>
    </div>
  </main>

  <!-- RIGHT: notes -->
  <aside>
    <div class="panel">
      <div class="notesHeader">
        <div style="font-weight:700">üìù Catatan</div>
        <div class="muted small">Tersimpan lokal</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="noteInput" placeholder="Tulis catatan singkat..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #e6eefb">
        <button class="btn small" onclick="addNote()">Simpan</button>
      </div>

      <div class="notesList" id="notesList"></div>
      <div style="margin-top:12px;text-align:center" class="muted small">Gunakan Import/Export untuk pindah data antar perangkat</div>
    </div>
  </aside>
</div>

<!-- MODAL: Category (links list) -->
<div class="backdrop" id="modalCategory">
  <div class="modal" role="dialog">
    <header>
      <div>
        <h3 id="modalCatTitle">Kategori</h3>
        <div class="muted small" id="modalCatSub">Daftar link</div>
      </div>
      <div><button class="btn.ghost small" onclick="closeModal('modalCategory')">‚úñÔ∏è Tutup</button></div>
    </header>

    <div style="display:flex;gap:12px">
      <div style="flex:1">
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <button class="btn.small" onclick="openAddLink()">+ Tambah Link</button>
          <button class="btn.small ghost" onclick="exportCategory()">üíæ Ekspor kategori</button>
        </div>
        <div id="modalLinkList" style="display:flex;flex-direction:column;gap:8px;max-height:52vh;overflow:auto"></div>
      </div>

      <div style="width:260px">
        <div class="kv">Informasi</div>
        <div class="muted" id="modalCatInfo">‚Äî</div>
        <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
          <button class="btn.ghost small" onclick="openEditCategory()">‚úèÔ∏è Edit kategori</button>
          <button class="btn small" style="background:var(--danger)" onclick="deleteCategory()">üóë Hapus kategori</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Add/Edit Link -->
<div class="backdrop" id="modalLinkForm">
  <div class="modal" role="dialog">
    <header>
      <div><h3 id="linkFormTitle">Tambah Link</h3><div class="muted small">Isi judul, URL, kategori</div></div>
      <div><button class="btn.ghost small" onclick="closeModal('modalLinkForm')">‚úñÔ∏è</button></div>
    </header>

    <form id="formLink" onsubmit="event.preventDefault(); saveLink()">
      <div class="formRow">
        <input id="linkTitle" placeholder="Judul (contoh: Materi PKBM)" required>
        <select id="linkCategory"></select>
      </div>
      <div class="formRow">
        <input id="linkUrl" placeholder="https://contoh.com" required>
      </div>
      <div style="margin-bottom:8px">
        <textarea id="linkNote" placeholder="Catatan (opsional)" style="width:100%;min-height:72px;padding:10px;border-radius:8px;border:1px solid #e6eefb"></textarea>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button type="button" class="btn.ghost small" onclick="closeModal('modalLinkForm')">Batal</button>
        <button type="submit" class="btn small">Simpan</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Add/Edit Category -->
<div class="backdrop" id="modalCategoryForm">
  <div class="modal" role="dialog">
    <header>
      <div><h3 id="catFormTitle">Tambah Kategori</h3><div class="muted small">Nama & parent (opsional)</div></div>
      <div><button class="btn.ghost small" onclick="closeModal('modalCategoryForm')">‚úñÔ∏è</button></div>
    </header>

    <form id="formCat" onsubmit="event.preventDefault(); saveCategory()">
      <div class="formRow">
        <input id="catName" placeholder="Nama kategori" required>
        <select id="catParent"><option value="">‚Äî Tanpa parent</option></select>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button type="button" class="btn.ghost small" onclick="closeModal('modalCategoryForm')">Batal</button>
        <button type="submit" class="btn small">Simpan</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Manage (kategori + sub) -->
<div class="backdrop" id="modalManage">
  <div class="modal" role="dialog" style="max-width:900px">
    <header>
      <div><h3>Kelola Kategori</h3><div class="muted small">Tambah / edit / hapus / subkategori</div></div>
      <div><button class="btn.ghost small" onclick="closeModal('modalManage')">‚úñÔ∏è</button></div>
    </header>

    <div style="display:flex;gap:12px">
      <div style="flex:1">
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <input id="manageNewCat" placeholder="Nama kategori baru">
          <button class="btn small" onclick="manageAdd()">Tambah</button>
        </div>
        <div id="manageList" style="display:flex;flex-direction:column;gap:8px;max-height:56vh;overflow:auto"></div>
      </div>
      <div style="width:260px">
        <div class="muted">Klik "‚ûï Sub" untuk buat subkategori. Hapus kategori memberi peringatan jika ada link terkait.</div>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button class="btn.ghost small" onclick="closeModal('modalManage')">Selesai</button>
    </div>
  </div>
</div>

<!-- MODAL: Import/Export -->
<div class="backdrop" id="modalImport">
  <div class="modal" role="dialog">
    <header>
      <div><h3>Import / Export</h3><div class="muted small">Download atau upload file .json</div></div>
      <div><button class="btn.ghost small" onclick="closeModal('modalImport')">‚úñÔ∏è</button></div>
    </header>

    <div style="display:flex;gap:12px">
      <div style="flex:1">
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <button class="btn small" onclick="doExport()">üíæ Download .json</button>
          <button class="btn.ghost small" onclick="previewExport()">üîç Preview</button>
        </div>
        <textarea id="exportPreview" style="width:100%;height:220px;display:none;padding:10px;border-radius:8px;border:1px solid #e6eefb;font-family:monospace"></textarea>

        <div style="margin-top:12px">
          <label class="muted small">Pilih file .json untuk import</label>
          <input type="file" id="importFile" accept=".json" onchange="handleImport(event)">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn.ghost small" onclick="closeModal('modalImport')">Batal</button>
            <button id="applyImportBtn" class="btn small" style="display:none" onclick="applyImport()">Terapkan</button>
          </div>
        </div>
      </div>

      <div style="width:240px;background:#fbfdff;padding:12px;border-radius:8px;border:1px solid #eef6ff">
        <div class="muted small">Ringkasan</div>
        <div id="importSummary" style="margin-top:8px">Belum ada preview</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================
 DATA MODEL & STORAGE KEYS
 ============================ */
const uid = ()=>Date.now().toString(36) + Math.random().toString(36).slice(2,6);
const K_CATS = 'portal_cats_v2';
const K_LINKS = 'portal_links_v2';
const K_NOTES = 'portal_notes_v2';

// in-memory
let categories = JSON.parse(localStorage.getItem(K_CATS)) || [];
let links = JSON.parse(localStorage.getItem(K_LINKS)) || [];
let notes = JSON.parse(localStorage.getItem(K_NOTES)) || [];

/* Undo stack: store snapshots (max size) */
const UNDO_MAX = 40;
let undoStack = []; // array of snapshots
function pushUndo(label='change'){
  undoStack.push({
    at: new Date().toISOString(),
    label,
    cats: JSON.parse(JSON.stringify(categories)),
    links: JSON.parse(JSON.stringify(links)),
    notes: JSON.parse(JSON.stringify(notes))
  });
  if(undoStack.length > UNDO_MAX) undoStack.shift();
}
function doUndo(){
  if(undoStack.length === 0) { alert('Tidak ada perubahan untuk di-undo'); return; }
  const snapshot = undoStack.pop();
  categories = snapshot.cats;
  links = snapshot.links;
  notes = snapshot.notes;
  persist();
  renderAll();
  alert('Undo: ' + (snapshot.label || 'perubahan sebelumnya') );
}

/* ensure default category */
function ensureDefault(){
  if(!Array.isArray(categories) || categories.length === 0){
    categories = [{id:'c_inbox', name:'Umum', parentId:null, order:0}];
    persist();
  }
}
ensureDefault();

/* persist to localStorage */
function persist(){
  localStorage.setItem(K_CATS, JSON.stringify(categories));
  localStorage.setItem(K_LINKS, JSON.stringify(links));
  localStorage.setItem(K_NOTES, JSON.stringify(notes));
}

/* save wrapper with undo push */
function saveWithUndo(label){
  pushUndo(label);
  persist();
}

/* ============================
 RENDER: categories grid
 ============================ */
function renderCategories(){
  const area = document.getElementById('categoriesArea');
  const q = document.getElementById('searchMain').value.trim().toLowerCase();
  area.innerHTML = '';

  // order categories by 'order' property (if missing, 0)
  const parents = categories.filter(c=>!c.parentId).slice().sort((a,b)=> (a.order||0) - (b.order||0));

  parents.forEach(parent => {
    const parentCard = createCategoryCard(parent, q);
    if(parentCard) area.appendChild(parentCard);

    // show subcategories as smaller cards
    const subs = categories.filter(c=>c.parentId === parent.id).slice().sort((a,b)=> (a.order||0) - (b.order||0));
    subs.forEach(s => {
      const subCard = createCategoryCard(s, q, true);
      if(subCard) area.appendChild(subCard);
    });
  });
}

/* create one category card element */
function createCategoryCard(cat, q, isSub=false){
  // find links for this category
  const catLinks = links.filter(l=>l.categoryId === cat.id);
  // apply search filter: show if category name matches OR any link matches
  const matchesCategory = cat.name.toLowerCase().includes(q);
  const matchesLink = catLinks.some(l => (l.title+' '+l.url+' '+(l.note||'')).toLowerCase().includes(q));
  if(q && !matchesCategory && !matchesLink) return null;

  const card = document.createElement('div'); card.className='catCard';
  if(isSub) { card.style.opacity = '0.95'; }

  // big circle
  const big = document.createElement('div'); big.className='catBig';
  const grad = pickGradient(cat.name);
  big.style.background = `linear-gradient(135deg, ${grad[0]}, ${grad[1]})`;
  big.textContent = cat.name.charAt(0).toUpperCase();

  // drag attributes for category
  big.setAttribute('draggable','true');
  big.addEventListener('dragstart', (e)=> {
    e.dataTransfer.setData('text/plain', JSON.stringify({type:'cat', id:cat.id}));
    big.classList.add('dragging');
  });
  big.addEventListener('dragend', ()=> big.classList.remove('dragging'));

  big.onclick = ()=> openCategoryModal(cat.id);
  card.appendChild(big);

  // name
  const name = document.createElement('div'); name.className='catName'; name.textContent = cat.name; card.appendChild(name);

  // small icons (show up to 8)
  const smallWrap = document.createElement('div'); smallWrap.className='linkIcons';
  const recent = catLinks.slice().sort((a,b)=> (a.order||0)-(b.order||0)).slice(0,8);
  recent.forEach(l=>{
    const s = document.createElement('div'); s.className='linkSmall';
    // make draggable (reorder links)
    s.setAttribute('draggable','true');
    s.addEventListener('dragstart', (e)=> {
      e.dataTransfer.setData('text/plain', JSON.stringify({type:'link', id:l.id, fromCat: l.categoryId}));
      s.classList.add('dragging');
    });
    s.addEventListener('dragend', ()=> s.classList.remove('dragging'));

    const img = document.createElement('img'); img.alt = l.title;
    try {
      const host = (new URL(l.url)).hostname;
      img.src = `https://www.google.com/s2/favicons?domain=${host}&sz=64`;
    } catch(e){ img.src = ''; }
    img.onerror = function(){
      this.style.display='none';
      const fallback = document.createElement('div');
      fallback.style.fontWeight='700';
      fallback.style.color='#0b1220';
      fallback.textContent = l.title.charAt(0).toUpperCase();
      this.parentNode.appendChild(fallback);
    };
    s.appendChild(img);

    // click opens link
    s.onclick = (ev)=> { ev.stopPropagation(); window.open(l.url, '_blank'); };
    // right-click edit
    s.oncontextmenu = (ev)=> { ev.preventDefault(); ev.stopPropagation(); openEditLink(l.id); return false; };

    smallWrap.appendChild(s);
  });

  if(recent.length === 0){
    const hint = document.createElement('div'); hint.className='muted'; hint.style.fontSize='13px'; hint.textContent = 'Belum ada link';
    card.appendChild(hint);
  } else {
    // allow dropping links onto this card to move them here
    smallWrap.addEventListener('dragover', (e)=> e.preventDefault());
    smallWrap.addEventListener('drop', (e)=>{
      e.preventDefault();
      try {
        const d = JSON.parse(e.dataTransfer.getData('text/plain'));
        if(d.type === 'link'){
          // move link to this category and put at end
          pushUndo('pindah link');
          const linkObj = links.find(x=>x.id===d.id);
          if(linkObj){
            linkObj.categoryId = cat.id;
            linkObj.order = (Math.max(-1, ...links.filter(l=>l.categoryId===cat.id).map(x=>x.order||0)) + 1);
            persist();
            renderAll();
          }
        }
      } catch(e){}
    });
    card.appendChild(smallWrap);
  }

  // allow dropping category reordering on card container
  card.addEventListener('dragover', (e)=> { e.preventDefault(); });
  card.addEventListener('drop', (e)=>{
    e.preventDefault();
    try{
      const d = JSON.parse(e.dataTransfer.getData('text/plain'));
      if(d.type === 'cat' && d.id !== cat.id){
        pushUndo('reorder kategori');
        // reorder: move dragged category to position of this category
        const ids = categories.filter(c=>!c.parentId).map(c=>c.id);
        const from = ids.indexOf(d.id); const to = ids.indexOf(cat.id);
        if(from>-1 && to>-1){
          ids.splice(from,1);
          ids.splice(to,0,d.id);
          // write order values
          ids.forEach((id, idx)=> {
            const c = categories.find(x=>x.id===id); if(c) c.order = idx;
          });
          persist(); renderAll();
        }
      } else if(d.type === 'link'){
        // move link into this category
        pushUndo('pindah link');
        const linkObj = links.find(x=>x.id===d.id);
        if(linkObj){
          linkObj.categoryId = cat.id;
          linkObj.order = (Math.max(-1, ...links.filter(l=>l.categoryId===cat.id).map(x=>x.order||0)) + 1);
          persist(); renderAll();
        }
      }
    }catch(e){}
  });

  return card;
}

/* gradient picker */
function pickGradient(text){
  let h=0; for(let i=0;i<text.length;i++) h = (h*31 + text.charCodeAt(i))|0;
  const palettes = [
    ['#2563eb','#60a5fa'], ['#ef4444','#fb7185'], ['#10b981','#34d399'],
    ['#f59e0b','#fbbf24'], ['#8b5cf6','#a78bfa'], ['#06b6d4','#67e8f9'],
    ['#f97316','#fb923c']
  ];
  return palettes[Math.abs(h)%palettes.length];
}

/* ============================
 MODALS: category modal content
 ============================ */
let currentCategory = null;
function openCategoryModal(catId){
  currentCategory = categories.find(c=>c.id===catId);
  if(!currentCategory) return;
  document.getElementById('modalCatTitle').textContent = currentCategory.name;
  document.getElementById('modalCatSub').textContent = `Link dalam "${currentCategory.name}"`;
  document.getElementById('modalCatInfo').textContent = `${links.filter(l=>l.categoryId===catId).length} link`;
  renderModalLinks(catId);
  showModal('modalCategory');
}
function renderModalLinks(catId){
  const list = document.getElementById('modalLinkList'); list.innerHTML = '';
  const items = links.filter(l => l.categoryId === catId).slice().sort((a,b)=> (a.order||0)-(b.order||0));
  if(items.length === 0){ list.innerHTML = '<div class="muted">Belum ada link.</div>'; return; }
  items.forEach(l=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.justifyContent='space-between'; row.style.padding='10px'; row.style.borderRadius='10px'; row.style.background='linear-gradient(180deg,#fff,#fbfdff)'; row.style.border='1px solid rgba(15,23,42,0.03)';
    // left
    const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='12px';
    const fav = document.createElement('div'); fav.style.width='48px'; fav.style.height='48px'; fav.style.borderRadius='8px'; fav.style.background='#f1f5f9'; fav.style.display='flex'; fav.style.alignItems='center'; fav.style.justifyContent='center'; fav.style.overflow='hidden';
    const img = document.createElement('img'); img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    try{ img.src = `https://www.google.com/s2/favicons?domain=${(new URL(l.url)).hostname}&sz=64`; }catch(e){ img.src=''; }
    img.onerror = function(){ this.style.display='none'; const t=document.createElement('div'); t.textContent = l.title.charAt(0).toUpperCase(); t.style.fontWeight='800'; t.style.color='#0b1220'; fav.appendChild(t); };
    fav.appendChild(img);
    const txt = document.createElement('div'); txt.innerHTML = `<div style="font-weight:700">${escape(l.title)}</div><div class="muted" style="font-size:13px">${escape(l.url)}</div>${l.note?'<div style="margin-top:6px;color:#334155">'+escape(l.note)+'</div>':''}`;
    left.appendChild(fav); left.appendChild(txt);

    // actions
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
    // drag handle - allow reordering links by dragging entire row
    row.setAttribute('draggable','true');
    row.addEventListener('dragstart',(e)=> { e.dataTransfer.setData('text/plain', JSON.stringify({type:'link-row', id:l.id})); row.classList.add('dragging'); });
    row.addEventListener('dragend',()=> row.classList.remove('dragging'));
    // drop reordering
    row.addEventListener('dragover', (e)=> e.preventDefault());
    row.addEventListener('drop', (e)=> {
      e.preventDefault();
      try {
        const d = JSON.parse(e.dataTransfer.getData('text/plain'));
        if(d.type === 'link-row' && d.id !== l.id){
          pushUndo('reorder link');
          // move dragged link just above this target
          const sameCat = links.filter(x=>x.categoryId===catId).slice().sort((a,b)=> (a.order||0)-(b.order||0));
          const fromIdx = sameCat.findIndex(x=>x.id===d.id);
          const toIdx = sameCat.findIndex(x=>x.id===l.id);
          if(fromIdx>-1 && toIdx>-1){
            const idList = sameCat.map(x=>x.id);
            idList.splice(fromIdx,1);
            idList.splice(toIdx,0,d.id);
            idList.forEach((id, idx)=> { const obj = links.find(x=>x.id===id); if(obj) obj.order = idx; });
            persist(); renderAll(); openCategoryModal(catId);
          }
        }
      } catch(e){}
    });

    const openBtn = document.createElement('button'); openBtn.className='btn small'; openBtn.textContent='Buka'; openBtn.onclick = ()=> window.open(l.url,'_blank');
    const editBtn = document.createElement('button'); editBtn.className='btn.ghost small'; editBtn.textContent='‚úèÔ∏è'; editBtn.onclick = ()=> openEditLink(l.id);
    const delBtn = document.createElement('button'); delBtn.className='btn small'; delBtn.style.background='var(--danger)'; delBtn.textContent='üóë'; delBtn.onclick = ()=> { if(!confirm('Hapus link?')) return; pushUndo('hapus link'); links = links.filter(x=>x.id!==l.id); persist(); renderAll(); openCategoryModal(catId); };

    actions.appendChild(openBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);
    row.appendChild(left); row.appendChild(actions);
    list.appendChild(row);
  });
}

/* ============================
 Link add/edit flows
 ============================ */
let editingLinkId = null;
function openAddLink(){
  editingLinkId = null;
  document.getElementById('linkFormTitle').textContent = 'Tambah Link';
  fillCategorySelect('linkCategory');
  if(currentCategory) document.getElementById('linkCategory').value = currentCategory.id;
  document.getElementById('linkTitle').value=''; document.getElementById('linkUrl').value=''; document.getElementById('linkNote').value='';
  showModal('modalLinkForm');
}
function openEditLink(id){
  editingLinkId = id;
  const obj = links.find(x=>x.id===id); if(!obj) return;
  document.getElementById('linkFormTitle').textContent = 'Edit Link';
  fillCategorySelect('linkCategory');
  document.getElementById('linkTitle').value = obj.title;
  document.getElementById('linkUrl').value = obj.url;
  document.getElementById('linkNote').value = obj.note || '';
  document.getElementById('linkCategory').value = obj.categoryId;
  showModal('modalLinkForm');
}
function saveLink(){
  const title = document.getElementById('linkTitle').value.trim();
  const url = document.getElementById('linkUrl').value.trim();
  const note = document.getElementById('linkNote').value.trim();
  const cat = document.getElementById('linkCategory').value;
  if(!title || !url || !cat) return alert('Lengkapi semua kolom.');
  if(editingLinkId){
    pushUndo('edit link');
    const obj = links.find(x=>x.id===editingLinkId);
    obj.title = title; obj.url = url; obj.note = note; obj.categoryId = cat;
    editingLinkId = null;
  } else {
    pushUndo('tambah link');
    links.push({id:uid(), title, url, note, categoryId:cat, order:(Math.max(-1, ...links.filter(l=>l.categoryId===cat).map(x=>x.order||0)) + 1)});
  }
  persist(); renderAll(); closeModal('modalLinkForm'); if(cat) openCategoryModal(cat);
}

/* fill categories for selects */
function fillCategorySelect(id){
  const sel = document.getElementById(id); sel.innerHTML = '';
  categories.forEach(c => sel.appendChild(new Option(c.parentId ? (getParentName(c) + ' / ' + c.name) : c.name, c.id)));
}

/* ============================
 Category add/edit flows
 ============================ */
let editingCategoryId = null;
function openAddCategory(){
  editingCategoryId = null;
  document.getElementById('catFormTitle').textContent = 'Tambah Kategori';
  document.getElementById('catName').value = '';
  fillCatParent();
  showModal('modalCategoryForm');
}
function openEditCategory(){
  if(!currentCategory) return;
  editingCategoryId = currentCategory.id;
  document.getElementById('catFormTitle').textContent = 'Edit Kategori';
  document.getElementById('catName').value = currentCategory.name;
  fillCatParent();
  document.getElementById('catParent').value = currentCategory.parentId || '';
  showModal('modalCategoryForm');
}
function saveCategory(){
  const name = document.getElementById('catName').value.trim();
  const parent = document.getElementById('catParent').value || null;
  if(!name) return alert('Isi nama kategori.');
  if(editingCategoryId){
    pushUndo('edit kategori');
    const obj = categories.find(c=>c.id===editingCategoryId);
    obj.name = name; obj.parentId = parent;
    editingCategoryId = null;
  } else {
    pushUndo('tambah kategori');
    categories.push({id:uid(), name, parentId: parent, order: (Math.max(-1, ...categories.filter(c=>!c.parentId).map(x=>x.order||0)) + 1)});
  }
  persist(); renderAll(); closeModal('modalCategoryForm');
}
function fillCatParent(){
  const sel = document.getElementById('catParent'); sel.innerHTML = '<option value="">‚Äî Tanpa parent</option>';
  categories.forEach(c => sel.appendChild(new Option(c.name, c.id)));
}

/* manage modal actions */
function openManageModal(){ renderManageList(); showModal('modalManage'); }
function manageAdd(){
  const name = document.getElementById('manageNewCat').value.trim();
  if(!name) return alert('Isi nama kategori.');
  pushUndo('tambah kategori');
  categories.push({id:uid(), name, parentId:null, order:(Math.max(-1, ...categories.filter(c=>!c.parentId).map(x=>x.order||0)) + 1)});
  document.getElementById('manageNewCat').value='';
  persist(); renderManageList(); renderCategories();
}
function renderManageList(){
  const box = document.getElementById('manageList'); box.innerHTML = '';
  const parents = categories.filter(c=>!c.parentId).slice().sort((a,b)=> (a.order||0)-(b.order||0));
  parents.forEach(p=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px'; row.style.borderRadius='10px'; row.style.background='linear-gradient(180deg,#fff,#fbfdff)'; row.style.border='1px solid rgba(15,23,42,0.03)';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${p.name}</div><div class="muted">${links.filter(l=>l.categoryId===p.id).length} link</div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
    const addSub = document.createElement('button'); addSub.className='btn small'; addSub.textContent='‚ûï Sub'; addSub.onclick = ()=> { const n = prompt('Nama subkategori untuk '+p.name); if(n){ pushUndo('tambah subkategori'); categories.push({id:uid(), name:n.trim(), parentId:p.id, order: (Math.max(-1, ...categories.filter(c=>c.parentId===p.id).map(x=>x.order||0)) + 1)}); persist(); renderManageList(); renderCategories(); } };
    const edit = document.createElement('button'); edit.className='btn.ghost small'; edit.textContent='‚úèÔ∏è'; edit.onclick = ()=> { editingCategoryId = p.id; document.getElementById('catName').value = p.name; fillCatParent(); document.getElementById('catParent').value = p.parentId||''; showModal('modalCategoryForm'); };
    const del = document.createElement('button'); del.className='btn small'; del.style.background='var(--danger)'; del.textContent='üóë'; del.onclick = ()=> { const subCount = categories.filter(c=>c.parentId===p.id).length; const linkCount = links.filter(l=>l.categoryId===p.id).length; if(!confirm(`Hapus kategori "${p.name}"?${subCount?`\nAda ${subCount} subkategori.`:''}${linkCount?`\nAda ${linkCount} link akan dihapus.`:''}`)) return; pushUndo('hapus kategori'); const remove = [p.id].concat(categories.filter(s=>s.parentId===p.id).map(s=>s.id)); categories = categories.filter(c=>!remove.includes(c.id)); links = links.filter(l=>!remove.includes(l.categoryId)); persist(); renderManageList(); renderCategories(); };
    right.appendChild(addSub); right.appendChild(edit); right.appendChild(del);
    row.appendChild(left); row.appendChild(right); box.appendChild(row);

    // subs
    categories.filter(s=>s.parentId===p.id).slice().sort((a,b)=> (a.order||0)-(b.order||0)).forEach(s=>{
      const srow = document.createElement('div'); srow.style.display='flex'; srow.style.justifyContent='space-between'; srow.style.alignItems='center'; srow.style.padding='8px'; srow.style.borderRadius='10px'; srow.style.marginLeft='10px'; srow.style.background='linear-gradient(180deg,#fff,#fcfeff)'; srow.style.border='1px solid rgba(15,23,42,0.03)';
      const sleft = document.createElement('div'); sleft.innerHTML = `<div style="font-weight:700">${s.name}</div><div class="muted">${links.filter(l=>l.categoryId===s.id).length} link</div>`;
      const sright = document.createElement('div'); sright.style.display='flex'; sright.style.gap='6px';
      const sedit = document.createElement('button'); sedit.className='btn.ghost small'; sedit.textContent='‚úèÔ∏è'; sedit.onclick = ()=> { editingCategoryId = s.id; document.getElementById('catName').value = s.name; fillCatParent(); document.getElementById('catParent').value = s.parentId||''; showModal('modalCategoryForm'); };
      const sdel = document.createElement('button'); sdel.className='btn small'; sdel.style.background='var(--danger)'; sdel.textContent='üóë'; sdel.onclick = ()=> { const linkCount = links.filter(l=>l.categoryId===s.id).length; if(!confirm(`Hapus subkategori "${s.name}"?${linkCount?`\nAda ${linkCount} link yang akan dihapus.`:''}`)) return; pushUndo('hapus subkategori'); categories = categories.filter(c=>c.id!==s.id); links = links.filter(l=>l.categoryId!==s.id); persist(); renderManageList(); renderCategories(); };
      sright.appendChild(sedit); sright.appendChild(sdel); srow.appendChild(sleft); srow.appendChild(sright); box.appendChild(srow);
    });
  });
}

/* ============================
 Import / Export global
 ============================ */
let importBuffer = null;
function openImportModal(){ document.getElementById('exportPreview').style.display='none'; document.getElementById('applyImportBtn').style.display='none'; showModal('modalImport'); }
function doExport(){
  const payload = { categories, links, notes, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'portal_data.json'; a.click();
}
function previewExport(){
  const payload = { categories, links, notes, exportedAt: new Date().toISOString() };
  const ta = document.getElementById('exportPreview'); ta.style.display = 'block'; ta.value = JSON.stringify(payload,null,2);
  document.getElementById('importSummary').textContent = `Kategori: ${categories.length}, Link: ${links.length}, Notes: ${notes.length}`;
}
function handleImport(evt){
  const f = evt.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=> {
    try{
      const parsed = JSON.parse(r.result);
      if(!parsed.categories || !parsed.links) return alert('Format file tidak valid.');
      importBuffer = parsed;
      document.getElementById('importSummary').textContent = `Siap import ‚Äî kategori:${parsed.categories.length}, link:${parsed.links.length}`;
      document.getElementById('applyImportBtn').style.display = 'inline-block';
    }catch(err){ alert('Gagal membaca file: '+err.message); }
  };
  r.readAsText(f);
}
function applyImport(){
  if(!importBuffer) return alert('Tidak ada file untuk diimpor.');
  if(confirm('OK = MERGE (gabungkan). Cancel = REPLACE (ganti semua).')){
    // merge
    const existingCatIds = new Set(categories.map(c=>c.id));
    const newCats = importBuffer.categories.map(c => ({...c, id: existingCatIds.has(c.id) ? uid() : c.id}));
    const map = {}; importBuffer.categories.forEach((c,i)=> map[c.id] = newCats[i].id);
    newCats.forEach(n => { if(n.parentId) n.parentId = map[n.parentId] || n.parentId; });
    const existingLinkIds = new Set(links.map(l=>l.id));
    const newLinks = importBuffer.links.map(l => ({...l, id: existingLinkIds.has(l.id) ? uid() : l.id, categoryId: map[l.categoryId] || l.categoryId}));
    categories = categories.concat(newCats);
    links = links.concat(newLinks);
    notes = notes.concat((importBuffer.notes||[]).map(n=>({id:n.id||uid(), text:n.text||'', createdAt:n.createdAt||new Date().toISOString()})));
    persist(); renderAll(); alert('Merge selesai.');
  } else {
    // replace
    categories = (importBuffer.categories||[]).map(c=>({id:c.id||uid(), name:c.name||'Unnamed', parentId:c.parentId||null, order:c.order||0}));
    links = (importBuffer.links||[]).map(l=>({id:l.id||uid(), title:l.title||'Untitled', url:l.url||'#', categoryId:l.categoryId || (categories[0] && categories[0].id), note:l.note||'', order:l.order||0}));
    notes = (importBuffer.notes||[]).map(n=>({id:n.id||uid(), text:n.text||'', createdAt:n.createdAt||new Date().toISOString()}));
    persist(); renderAll(); alert('Replace selesai.');
  }
  importBuffer = null; document.getElementById('applyImportBtn').style.display='none'; closeModal('modalImport');
}

/* export single category */
function exportCategory(){
  if(!currentCategory) return alert('Tidak ada kategori terpilih');
  const cat = currentCategory;
  const subIds = categories.filter(c=>c.parentId === cat.id).map(c=>c.id);
  const packed = {
    categories: categories.filter(c=>c.id === cat.id || c.parentId === cat.id || c.parentId === null && c.id === cat.id),
    links: links.filter(l => l.categoryId === cat.id || subIds.includes(l.categoryId)),
    notes,
    exportedAt: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(packed,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `category_${cat.name.replace(/\s+/g,'_')}.json`; a.click();
}

/* ============================
 NOTES (right column)
 ============================ */
function renderNotes(){
  const box = document.getElementById('notesList'); box.innerHTML = '';
  if(!Array.isArray(notes) || notes.length === 0){ box.innerHTML = '<div class="muted">Belum ada catatan.</div>'; return; }
  notes.slice().reverse().forEach(n=>{
    const card = document.createElement('div'); card.className = 'noteCard';
    card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:start"><div style="font-weight:700">${(new Date(n.createdAt)).toLocaleString()}</div><div style="display:flex;gap:6px"><button class="btn.ghost small" onclick="editNote('${n.id}')">‚úèÔ∏è</button><button class="btn small" style="background:var(--danger)" onclick="deleteNote('${n.id}')">üóë</button></div></div><div style="margin-top:8px;color:#334155">${escape(n.text)}</div>`;
    box.appendChild(card);
  });
}
function addNote(){
  const v = document.getElementById('noteInput').value.trim();
  if(!v) return alert('Catatan kosong');
  pushUndo('tambah catatan');
  notes.push({id:uid(), text:v, createdAt:new Date().toISOString()});
  document.getElementById('noteInput').value='';
  persist(); renderNotes();
}
function editNote(id){
  const idx = notes.findIndex(n=>n.id===id); if(idx<0) return;
  const t = prompt('Edit catatan', notes[idx].text); if(t===null) return;
  if(t.trim()===''){ if(confirm('Hapus catatan?')){ pushUndo('hapus catatan'); notes.splice(idx,1); persist(); renderNotes(); } return; }
  pushUndo('edit catatan');
  notes[idx].text = t.trim(); persist(); renderNotes();
}
function deleteNote(id){ if(!confirm('Hapus catatan ini?')) return; pushUndo('hapus catatan'); notes = notes.filter(n=>n.id!==id); persist(); renderNotes(); }

/* ============================
 UTILS: show/hide modal, renderAll, escape
 ============================ */
function showModal(id){ document.getElementById(id).style.display = 'flex'; }
function closeModal(id){ document.getElementById(id).style.display = 'none'; }

/* get parent name for display */
function getParentName(c){ const p = categories.find(x=>x.id===c.parentId); return p ? p.name : ''; }

/* escape HTML */
function escape(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

/* render everything */
function renderAll(){
  renderCategories();
  renderManageList();
  renderNotes();
}

/* ============================
 INITIALIZE & BIND
 ============================ */
function init(){
  ensureDefault();
  renderAll();

  // keyboard undo: Ctrl+Z
  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z'){
      e.preventDefault(); doUndo();
    }
    // '/' to focus search
    if(e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA'){
      e.preventDefault(); document.getElementById('searchMain').focus();
    }
  });

  // persist if storage changed in another tab
  window.addEventListener('storage', ()=> {
    categories = JSON.parse(localStorage.getItem(K_CATS)) || categories;
    links = JSON.parse(localStorage.getItem(K_LINKS)) || links;
    notes = JSON.parse(localStorage.getItem(K_NOTES)) || notes;
    renderAll();
  });

  // clicking outside modals closes them
  document.querySelectorAll('.backdrop').forEach(b => b.addEventListener('click', e => { if(e.target === b) b.style.display = 'none'; }));
}
init();

/* ============================
 Helper: open edit flows from within lists
 ============================ */
function openEditLink(id){ openEditLinkModal(id); } // alias for compatibility
function openEditLinkModal(id){
  openEditLink(id);
}

/* small wrappers to satisfy earlier-named functions used by UI */
function openEditCategory(){ openEditCategory(); } // no-op; handled by current flows
function deleteCategory(){ 
  if(!currentCategory) return;
  const c = currentCategory;
  const linkCount = links.filter(l=>l.categoryId===c.id).length;
  if(!confirm(`Hapus kategori "${c.name}"?${linkCount?`\n${linkCount} link akan dihapus.`:''}`)) return;
  pushUndo('hapus kategori');
  // remove category and its subs
  const toRemove = [c.id].concat(categories.filter(x=>x.parentId===c.id).map(x=>x.id));
  categories = categories.filter(x=>!toRemove.includes(x.id));
  links = links.filter(l=>!toRemove.includes(l.categoryId));
  persist();
  closeModal('modalCategory');
  renderAll();
}

/* For backward-compatibility call names (used earlier) */
function openEditLinkModal(id){ openEditLink(id); }

/* Expose some functions for debug in console */
window.__portal = { categories, links, notes, saveWithUndo, pushUndo, doUndo };

/* render manage list (for init) */
function renderManageList(){ /* reuse function declared */ renderManageList = renderManageList; renderManageList(); } // noop to ensure function exists
</script>
</body>
</html>
